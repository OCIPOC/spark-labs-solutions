<p><link rel='stylesheet' href='../../assets/css/main.css'/></p>
<p><a href="../../README.html">&lt;&lt; back to main index</a></p>
<h1 id="lab-8.4---structured-streaming-1">Lab 8.4 - Structured Streaming 1</h1>
<h3 id="overview">Overview</h3>
<p>Run a Spark Structured Streaming job using python</p>
<h3 id="depends-on">Depends On</h3>
<p>None</p>
<h3 id="run-time">Run time</h3>
<p>30-40 mins</p>
<h2 id="step-1-go-to-project-directory">STEP 1: Go to project directory</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">    $ <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured/python</a></code></pre></div>
<h2 id="step-2-fix-todo-1">Step 2 : Fix TODO-1</h2>
<p>Edit file : <code>structured-streaming.py</code> Uncomment code block around TODO-1 (and only this one), so your code looks like this.<br />
Delete &quot;&quot;&quot; and &quot;&quot;&quot; around the TODO blocks</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">## </span><span class="al">TODO</span><span class="co">-1 : read from socket 10000</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ex">lines</span> = spark \</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    .readStream \</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    .format(<span class="st">&quot;socket&quot;</span>) <span class="kw">\</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    <span class="ex">.option</span>(<span class="st">&quot;host&quot;</span>, <span class="st">&quot;localhost&quot;</span>) <span class="kw">\</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="ex">.option</span>(<span class="st">&quot;port&quot;</span>, 10000) <span class="kw">\</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    <span class="ex">.load</span>()</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co"># ----- end-</span><span class="al">TODO</span><span class="co">-1</span></a></code></pre></div>
<h2 id="step-3-run-netcat-server-to-simulate-network-traffic-terminal-1">Step 3: Run Netcat Server to simulate network traffic (terminal #1)</h2>
<p>Open another terminal into Spark node (terminal #2)</p>
<p>Use <code>nc</code> command to move text you type in terminal #1 to port 10000 Open an terminal and run this command at prompt</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1">    $ <span class="ex">nc</span> -lk 10000</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    <span class="co"># if this gives an error like &#39;Protocol not available&#39; use this</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    $  <span class="ex">~/bin/nc</span>  -lk 10000</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    </a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="co"># if this shows &#39;Port already in use&#39;, get the process is and kill the process</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    $ <span class="fu">sudo</span> netstat -plnt <span class="kw">|</span> <span class="fu">grep</span> 10000</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="co"># Process id will be shown in output</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    $ <span class="fu">sudo</span> kill -9 <span class="op">&lt;</span>process id<span class="op">&gt;</span></a></code></pre></div>
<h2 id="step-4-run-the-streaming-application">Step 4: Run the streaming application</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">    <span class="co"># be in project root directory</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    $ <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured/python</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    $ <span class="ex">~/spark/bin/spark-submit</span>  --master local[2]  --driver-class-path logging/ structured-streaming.py</a></code></pre></div>
<p>Lets call this Terminal #2</p>
<p>Also note –master url <code>local[2]</code> * We are using a local ‘embedded’ server (quick for development) * And we need at least 2 cpu cores – one for receiver (long running task) and another for our program.<br />
If only allocated one core <code>local[1]</code> the program will have run-time errors or won’t run!</p>
<h2 id="step-5-test-by-typing-text-in-the-terminal-1-in-netcat-server">Step 5: Test by typing text in the terminal #1 (in netcat server)</h2>
<p>In the Terminal #1, copy and paste the following lines (these are lines from our clickstream data)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="ex">Hello</span> world</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="ex">how</span> are you?</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="ex">good</span> bye</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="ex">world</span></a></code></pre></div>
<p>Inspect the output from Spark streaming on terminal #2</p>
<p>Output would be similar to the following:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="ex">Batch</span>: 0</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw">|</span><span class="ex">value</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="ex">Batch</span>: 1</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="ex">+------------+</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="kw">|</span>       <span class="ex">value</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="ex">+------------+</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="kw">|</span> <span class="ex">Hello</span> world<span class="kw">|</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="kw">|</span>    <span class="ex">good</span> bye<span class="kw">|</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="kw">|</span><span class="ex">how</span> are you?<span class="kw">|</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="ex">+------------+</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="ex">Batch</span>: 2</a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="kw">|</span><span class="ex">value</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26"><span class="kw">|</span><span class="ex">world</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="ex">+-----+</span></a></code></pre></div>
<h2 id="step-6-fix-todo-2-and-todo-3">Step 6: Fix TODO-2 and TODO-3</h2>
<p>Uncomment code block around TODO-2 and TODO-3 Delete &quot;&quot;&quot; and &quot;&quot;&quot; around the TODO blocks After uncommenting, code will be like the following</p>
<pre><code>## TODO-2  :filter lines that has &#39;x&#39;
x = lines.filter(lines[&quot;value&quot;].contains(&quot;x&quot;))
# ----- end-TODO-2

## TODO-3 : To run query2 , comment out query1
query2 = x \
        .writeStream \
        .outputMode(&quot;append&quot;) \
        .format(&quot;console&quot;) \
        .start()
# ----- end-TODO-3</code></pre>
<p>To run query2 , comment out query1 Comment TODO-1 before uncommenting the blocks within TODO-2 and TODO-3</p>
<h2 id="run-the-streaming-application">Run the streaming application</h2>
<p><strong>=&gt; Hit Ctrl+C on terminal #2 to kill the running Spark streaming application</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1">    <span class="co"># be in project root directory</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">    $ <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured/python</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    $ <span class="ex">~/spark/bin/spark-submit</span>  --master local[2]  --driver-class-path logging/ structured-streaming.py</a></code></pre></div>
<p>In the Terminal #1, copy and paste the following lines (these are lines from our clickstream data)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="ex">text</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="ex">data</span></a></code></pre></div>
<p>Inspect the output from Spark streaming on terminal #2</p>
<p>Output would be similar to the following:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="ex">Batch</span>: 1</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="kw">|</span><span class="ex">value</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="kw">|</span> <span class="ex">text</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="ex">Batch</span>: 2</a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="ex">-------------------------------------------</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="kw">|</span><span class="ex">value</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="ex">+-----+</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="ex">+-----+</span></a></code></pre></div>
<p><strong>=&gt; Hit Ctrl+C on terminal #2 to kill Spark streaming application</strong></p>
