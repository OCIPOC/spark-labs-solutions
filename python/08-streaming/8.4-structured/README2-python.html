<title>
Spark labs : 8.1 Streaming Over TCP
</title>
</head>
<p><link rel='stylesheet' href='../../assets/css/main.css'/></p>
<p><a href="../../README.html">&lt;&lt; back to main index</a></p>
<h1 id="lab-8.4---structured-streaming-2-json">Lab 8.4 - Structured Streaming 2 (JSON)</h1>
<h3 id="overview">Overview</h3>
<p>Run a Spark Structured Streaming job by analyzing JSON data</p>
<h3 id="depends-on">Depends On</h3>
<p>None</p>
<h3 id="run-time">Run time</h3>
<p>30-40 mins</p>
<h2 id="step-1-go-to-project-directory">STEP 1: Go to project directory</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">    $ <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured/python</a></code></pre></div>
<h2 id="step-2-inspect-file">Step 2 : Inspect file</h2>
<p><strong>Inspect file : <code>json_streaming.py</code></strong></p>
<h2 id="step-3-complete-todo-1">Step 3: Complete TODO-1</h2>
<p>Uncomment code block around TODO-1 (and only this one), so your code looks like this.<br />
Delete &quot;&quot;&quot; and &quot;&quot;&quot; around the TODO blocks</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># </span><span class="al">TODO</span><span class="co">-1 :  </span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ex">sample_data</span> = spark.read.json(<span class="st">&quot;file:///data/click-stream/clickstream.json&quot;</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="ex">sample_data.printSchema</span>()</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="ex">schema</span> = sample_data.schema</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="ex">print</span>(<span class="st">&quot;ClickStream sample schema is : &quot;</span> , schema)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co"># ----- end-</span><span class="al">TODO</span><span class="co">-1</span></a></code></pre></div>
<p>Save the file.</p>
<h2 id="step-4-run-the-streaming-application">Step 4: Run the streaming application</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1">    <span class="co"># be in project root directory</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    $ <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    $ <span class="ex">~/spark/bin/spark-submit</span>  --master local[2]   --driver-class-path logging/  json_streaming.py</a></code></pre></div>
<pre class="console"><code>root
 |-- action: string (nullable = true)
 |-- campaign: string (nullable = true)
 |-- cost: long (nullable = true)
 |-- domain: string (nullable = true)
 |-- ip: string (nullable = true)
 |-- session: string (nullable = true)
 |-- timestamp: long (nullable = true)
 |-- user: string (nullable = true)

Clickstream sample schema is : StructType(StructField(action,StringType,true), StructField(campaign,StringType,true), StructField(cost,LongType,true), StructField(domain,StringType,true), StructField(ip,StringType,true), StructField(session,StringType,true), StructField(timestamp,LongType,true), StructField(user,StringType,true))</code></pre>
<h2 id="step-6-fix-todo-2">Step 6: Fix TODO-2</h2>
<p>Edit file : <code>json_streaming.py</code>**<br />
Uncomment code block around TODO-2</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1">    <span class="co"># be in project root directory</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">    $ <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    $ <span class="fu">rm</span> -f json-input/*  <span class="kw">;</span>  </a>
<a class="sourceLine" id="cb5-4" data-line-number="4">        <span class="ex">~/spark/bin/spark-submit</span>  --master local[2]   --driver-class-path logging/  json_streaming.py</a></code></pre></div>
<p>Note : <code>rm -f json-input/*</code> is used to clear the input directory</p>
<p>Leave this terminal running (we will call it Spark terminal)</p>
<p>Open another terminal and issue the following commands.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1">    $ <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured/</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    $ <span class="fu">ln</span> /data/click-stream/clickstream.json json-input/1.json</a></code></pre></div>
<p>In Spark terminal you should see the first batch output</p>
<h2 id="console">```console</h2>
<h2 id="batch-0">Batch: 0</h2>
<p>+——-+———–+—-+—————–+—-+———-+————-+——+ | action| campaign|cost| domain| ip| session| timestamp| user| +——-+———–+—-+—————–+—-+———-+————-+——+ |clicked|campaign_19| 118| youtube.com|ip_4|session_36|1420070400000|user_9| |blocked|campaign_12| 5| facebook.com|ip_3|session_96|1420070400864|user_5| |clicked| campaign_3| 54|sf.craigslist.org|ip_9|session_61|1420070401728|user_8| |blocked|campaign_18| 110| wikipedia.org|ip_5|session_55|1420070402592|user_6| |clicked| campaign_6| 15|comedycentral.com|ip_9|session_49|1420070403456|user_4| |blocked| campaign_9| 139| cnn.com|ip_8|session_13|1420070404320|user_7| ….</p>
<p><strong>=&gt; Hit Ctrl+C on terminal #1 to kill Spark streaming application</strong></p>
<h2 id="step-7-todo-3-query1">Step 7 : TODO-3 (Query1)</h2>
<p>Edit file : <code>json_streaming.py</code>**<br />
Uncomment code block around TODO-3</p>
<p>Run streaming application</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1">    <span class="co"># be in project root directory</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">    $   <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured/python</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    $   <span class="fu">rm</span> -f json-input/*  <span class="kw">;</span>  </a>
<a class="sourceLine" id="cb7-4" data-line-number="4">        <span class="ex">~/spark/bin/spark-submit</span>  --master local[2]   --driver-class-path logging/  json_streaming.py</a></code></pre></div>
<p>Copy files into <code>json-input</code> directory as follows.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1">    $   <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">    $   <span class="fu">ln</span> /data/click-stream/clickstream.json json-input/1.json</a></code></pre></div>
<p>Spark will calculate results for query1:</p>
<pre class="console"><code>-------------------------------------------
Batch: 0
-------------------------------------------
// echo output
+-------+-----------+----+-----------------+----+----------+-------------+------+
| action|   campaign|cost|           domain|  ip|   session|    timestamp|  user|
| viewed| campaign_1|  24|        yahoo.com|ip_4|session_60|1420070411232|user_8|
|....
|blocked|campaign_19|  23|       amazon.com|ip_5|session_85|1420070415552|user_7|
| viewed|campaign_20| 133|       google.com|ip_9|session_69|1420070416416|user_7|
+-------+-----------+----+-----------------+----+----------+-------------+------+

// query1 output
+-----------------+-----+
|           domain|count|
+-----------------+-----+
|      nytimes.com|    1|
|      youtube.com|    2|
|        zynga.com|    1|
|       google.com|    2|
|        yahoo.com|    1|
|     facebook.com|    1|
|          cnn.com|    1|
|    wikipedia.org|    3|
|       sfgate.com|    1|
|       amazon.com|    2|
|   funnyordie.com|    1|
|sf.craigslist.org|    2|
|comedycentral.com|    2|
+-----------------+-----+</code></pre>
<p>Copy more files and see the <code>domain count</code> change</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1"></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    $ <span class="fu">ln</span> /data/click-stream/clickstream.json  json-input/2.json</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    $ <span class="fu">ln</span> /data/click-stream/clickstream.json  json-input/3.json</a></code></pre></div>
<p><strong>=&gt; Hit Ctrl+C on terminal #1 to kill Spark streaming application</strong></p>
<h2 id="step-8-todo-4-query2">Step 8 : TODO-4 (Query2)</h2>
<p>Edit file : <code>json_streaming.py</code>**<br />
Uncomment code block around TODO-4</p>
<p>Run streaming application</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" data-line-number="1">    <span class="co"># be in project root directory</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">    $ <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">    $ <span class="fu">rm</span> -f json-input/*  <span class="kw">;</span>  </a>
<a class="sourceLine" id="cb11-4" data-line-number="4">        <span class="ex">~/spark/bin/spark-submit</span>  --master local[2]   --driver-class-path logging/  json_streaming.py</a></code></pre></div>
<p>Copy files into <code>json-input</code> directory as follows.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1">    $   <span class="bu">cd</span> ~/spark-labs/08-streaming/8.4-structured</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">    $   <span class="fu">ln</span> /data/click-stream/clickstream.json    json-input/1.json</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">    $   <span class="fu">ln</span> /data/click-stream/clickstream.json    json-input/2.json</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    $   <span class="fu">ln</span> /data/click-stream/clickstream.json    json-input/3.json</a></code></pre></div>
<pre class="console"><code>-------------------------------------------
Batch: 0
-------------------------------------------
+-------+-----------+----+-----------------+----+----------+-------------+------+
| action|   campaign|cost|           domain|  ip|   session|    timestamp|  user|
+-------+-----------+----+-----------------+----+----------+-------------+------+
|clicked|campaign_19| 118|      youtube.com|ip_4|session_36|1420070400000|user_9|
|blocked|campaign_12|   5|     facebook.com|ip_3|session_96|1420070400864|user_5|
....
| viewed|campaign_20| 133|       google.com|ip_9|session_69|1420070416416|user_7|
+-------+-----------+----+-----------------+----+----------+-------------+------+

-------------------------------------------
Batch: 0
-------------------------------------------
+-------+-----------+----+-----------------+----+----------+-------------+------+
| action|   campaign|cost|           domain|  ip|   session|    timestamp|  user|
+-------+-----------+----+-----------------+----+----------+-------------+------+
|blocked|campaign_12|   5|     facebook.com|ip_3|session_96|1420070400864|user_5|
|blocked|campaign_18| 110|    wikipedia.org|ip_5|session_55|1420070402592|user_6|
|blocked| campaign_9| 139|          cnn.com|ip_8|session_13|1420070404320|user_7|
|blocked| campaign_4| 171|   funnyordie.com|ip_1|session_92|1420070405184|user_9|
|blocked|campaign_17|  20|       amazon.com|ip_4|session_13|1420070406048|user_1|
|blocked|campaign_20|  78|        zynga.com|ip_5|session_36|1420070406912|user_3|
|blocked|campaign_19| 147|      nytimes.com|ip_2|session_65|1420070407776|user_6|
|blocked| campaign_2|   7|      youtube.com|ip_2|session_93|1420070412960|user_1|
|blocked| campaign_9| 153|       google.com|ip_3|session_22|1420070413824|user_9|
|blocked| campaign_8| 140|comedycentral.com|ip_8| session_4|1420070414688|user_2|
|blocked|campaign_19|  23|       amazon.com|ip_5|session_85|1420070415552|user_7|
+-------+-----------+----+-----------------+----+----------+-------------+------+

-------------------------------------------
Batch: 0
-------------------------------------------
+-----------------+-----+
|           domain|count|
+-----------------+-----+
|      nytimes.com|    1|
|      youtube.com|    2|
|        zynga.com|    1|
|       google.com|    2|
|        yahoo.com|    1|
|     facebook.com|    1|
|          cnn.com|    1|
|    wikipedia.org|    3|
|       sfgate.com|    1|
|       amazon.com|    2|
|   funnyordie.com|    1|
|sf.craigslist.org|    2|
|comedycentral.com|    2|
+-----------------+-----+
</code></pre>
<p><strong>=&gt; Can you explain how <code>append</code> mode works for query2? </strong></p>
<p><strong>=&gt; Hit Ctrl+C on terminal #1 to kill Spark streaming application</strong></p>
