<h1 id="rdd-join-solutions">3.3 RDD Join solutions</h1>
<table>
<tbody>
<tr class="odd">
<td>Analyzing Meetup Data</td>
</tr>
</tbody>
</table>
<h4 id="start-spark-shell">Start Spark Shell</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">    $   <span class="ex">~/spark/bin/spark-shell</span></a></code></pre></div>
<h4 id="following-in-scala-shell">Following in Scala shell</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">    <span class="co">//scala</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="kw">val</span> meetups = sc.<span class="fu">textFile</span>(<span class="st">&quot;/data/meetup/meetup.csv&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    <span class="co">// inspect data</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    meetups.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    meetups.<span class="fu">foreach</span>(println)</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    <span class="co">// convert to (K,)</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">    <span class="co">// u1 -&gt; (m1,m2,m3)</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">    <span class="kw">val</span> userMeetupsKV = meetups.<span class="fu">map</span>(line =&gt; {</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">                        <span class="kw">val</span> tokens = line.<span class="fu">split</span>(<span class="st">&quot;,&quot;</span>) <span class="co">// split the line</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">                        <span class="kw">val</span> user = <span class="fu">tokens</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">                        <span class="kw">val</span> meetup = <span class="fu">tokens</span> (<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">                        (user, meetup) <span class="co">// create a KV pair (user, meetup)</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">                        })</a>
<a class="sourceLine" id="cb2-17" data-line-number="17"></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">    <span class="co">// lineage</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">    userMeetupsKV.<span class="fu">toDebugString</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">    <span class="co">// print</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">    userMeetupsKV.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">    userMeetupsKV.<span class="fu">foreach</span>(println)</a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">    <span class="co">// meetups per user</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">    <span class="kw">val</span> userMeetupsGrouped = userMeetupsKV.<span class="fu">groupByKey</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">    userMeetupsGrouped.<span class="fu">toDebugString</span> <span class="co">// lineage</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">    userMeetupsGrouped.<span class="fu">foreach</span> (println)</a>
<a class="sourceLine" id="cb2-28" data-line-number="28"></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">    <span class="co">// meetups for user &#39;u1&#39;</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">    userMeetupsGrouped.<span class="fu">filter</span>{<span class="kw">case</span> (u,m) =&gt; u == <span class="st">&quot;u1&quot;</span>}.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31"></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">    <span class="co">// count meetups per user</span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33">    <span class="kw">val</span> userMeetupCount = userMeetupsKV.<span class="fu">countByKey</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34">    userMeetupCount.<span class="fu">foreach</span>(println)</a>
<a class="sourceLine" id="cb2-35" data-line-number="35"></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">    <span class="co">// all unique meetups</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37">    <span class="co">// building up the solution</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38">    userMeetupsKV.<span class="fu">values</span></a>
<a class="sourceLine" id="cb2-39" data-line-number="39">    userMeetupsKV.<span class="fu">values</span>.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40">    userMeetupsKV.<span class="fu">values</span>.<span class="fu">distinct</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41">    userMeetupsKV.<span class="fu">values</span>.<span class="fu">collect</span>.<span class="fu">distinct</span></a>
<a class="sourceLine" id="cb2-42" data-line-number="42">    userMeetupsKV.<span class="fu">values</span>.<span class="fu">distinct</span>.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43"></a>
<a class="sourceLine" id="cb2-44" data-line-number="44">    <span class="co">// what is the difference between</span></a>
<a class="sourceLine" id="cb2-45" data-line-number="45">    <span class="co">//    userMeetupsKV.values.distinct.collect</span></a>
<a class="sourceLine" id="cb2-46" data-line-number="46">    <span class="co">//          vs</span></a>
<a class="sourceLine" id="cb2-47" data-line-number="47">    <span class="co">//      userMeetupsKV.values.collect.distinct</span></a>
<a class="sourceLine" id="cb2-48" data-line-number="48"></a>
<a class="sourceLine" id="cb2-49" data-line-number="49">    <span class="co">// all unique meetups sorted</span></a>
<a class="sourceLine" id="cb2-50" data-line-number="50">    userMeetupsKV.<span class="fu">values</span>.<span class="fu">distinct</span>.<span class="fu">collect</span>.<span class="fu">sorted</span></a>
<a class="sourceLine" id="cb2-51" data-line-number="51"></a>
<a class="sourceLine" id="cb2-52" data-line-number="52">    <span class="co">// data grouped by meetups (tranforming from existing RDD)</span></a>
<a class="sourceLine" id="cb2-53" data-line-number="53">    <span class="kw">val</span> meetupUsers = userMeetupsKV.<span class="fu">map</span>{<span class="kw">case</span>(user,meetup) =&gt; (meetup,user)}</a>
<a class="sourceLine" id="cb2-54" data-line-number="54">    meetupUsers.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb2-55" data-line-number="55">    meetupUsers.<span class="fu">foreach</span>(println)</a>
<a class="sourceLine" id="cb2-56" data-line-number="56"></a>
<a class="sourceLine" id="cb2-57" data-line-number="57">    <span class="co">// group all users per meetup</span></a>
<a class="sourceLine" id="cb2-58" data-line-number="58">    <span class="kw">val</span> meetupUsersGrouped = meetupUsers.<span class="fu">groupByKey</span></a>
<a class="sourceLine" id="cb2-59" data-line-number="59">    meetupUsersGrouped.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb2-60" data-line-number="60"></a>
<a class="sourceLine" id="cb2-61" data-line-number="61">    <span class="co">// count users for each meetup</span></a>
<a class="sourceLine" id="cb2-62" data-line-number="62">    <span class="kw">val</span> meetupUserCount = meetupUsers.<span class="fu">countByKey</span></a>
<a class="sourceLine" id="cb2-63" data-line-number="63">    <span class="co">// note : meetupUsersGrouped.countByKey is not right, why?</span></a>
<a class="sourceLine" id="cb2-64" data-line-number="64"></a>
<a class="sourceLine" id="cb2-65" data-line-number="65">    <span class="co">// sort meetups by popularity (#users DESC)</span></a>
<a class="sourceLine" id="cb2-66" data-line-number="66">    meetupUserCount.<span class="fu">toSeq</span>.<span class="fu">sortWith</span>((a,b) =&gt; a._<span class="dv">2</span> &gt; b._<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb2-67" data-line-number="67">    <span class="co">// the same thing using scala short notation</span></a>
<a class="sourceLine" id="cb2-68" data-line-number="68">    meetupUserCount.<span class="fu">toSeq</span>.<span class="fu">sortWith</span>(_._<span class="dv">2</span> &gt; _._<span class="dv">2</span>)</a></code></pre></div>
<table>
<tbody>
<tr class="odd">
<td>Analyzing Users Data</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb3"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb3-1" data-line-number="1"></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    <span class="co">// scala</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    <span class="kw">val</span> users = sc.<span class="fu">textFile</span>(<span class="st">&quot;/data/meetup/users.csv&quot;</span>)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="co">// create user RDD : user -&gt; gender</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="kw">val</span> usersKV = users.<span class="fu">map</span>(line =&gt; {</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">                        <span class="co">// use trim to remove extra spaces</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">                        <span class="kw">val</span> tokens = line.<span class="fu">split</span>(<span class="st">&quot;,&quot;</span>).<span class="fu">map</span>(_.<span class="fu">trim</span>)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">                        <span class="kw">val</span> userName = <span class="fu">tokens</span>(<span class="dv">0</span>) <span class="co">// first</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">                        <span class="kw">val</span> gender = <span class="fu">tokens</span>(<span class="dv">1</span>) <span class="co">// second</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">                        <span class="kw">val</span> langs = <span class="fu">tokens</span>(<span class="dv">2</span>).<span class="fu">split</span>(<span class="st">&quot;;&quot;</span>) <span class="co">// third, create lang array</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12">                        (userName, gender)</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">                        <span class="co">//(userName, (gender, langs))</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">                        <span class="co">//(userName, line)</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15">                        })</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">    usersKV.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"></a>
<a class="sourceLine" id="cb3-18" data-line-number="18">    <span class="co">// join meetup + users</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19">    <span class="kw">val</span> joinedUsersMeetups = usersKV.<span class="fu">join</span>(userMeetupsKV)</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">    joinedUsersMeetups.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21">    <span class="co">// result :  user -&gt; (gender, meetup)</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"></a>
<a class="sourceLine" id="cb3-23" data-line-number="23">    <span class="co">// gender -&gt; meetup</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">    <span class="kw">val</span> genderMeetups = joinedUsersMeetups.<span class="fu">map</span>{</a>
<a class="sourceLine" id="cb3-25" data-line-number="25">        <span class="kw">case</span> (user, (gender, meetup)) =&gt; (gender,meetup)</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">        }</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">    genderMeetups.<span class="fu">collect</span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28"></a>
<a class="sourceLine" id="cb3-29" data-line-number="29">    <span class="co">// male / female distribution</span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30">    genderMeetups.<span class="fu">countByKey</span></a>
<a class="sourceLine" id="cb3-31" data-line-number="31"></a>
<a class="sourceLine" id="cb3-32" data-line-number="32">    <span class="co">// meetup -&gt; gender</span></a>
<a class="sourceLine" id="cb3-33" data-line-number="33">    <span class="kw">val</span> meetupGender = genderMeetups.<span class="fu">map</span>{<span class="kw">case</span>(k,v) =&gt; (v,k)}</a>
<a class="sourceLine" id="cb3-34" data-line-number="34">    meetupGender.<span class="fu">collect</span></a></code></pre></div>
