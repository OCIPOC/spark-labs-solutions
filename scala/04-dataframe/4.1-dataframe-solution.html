<h1 id="lab-4.1-dataframe-solution">Lab 4.1 : Dataframe solution</h1>
<h4 id="start-spark-shell">Start Spark Shell</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">$   <span class="ex">~/spark/bin/spark-shell</span></a></code></pre></div>
<h4 id="following-in-scala-shell">Following in Scala shell</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">val</span> clickstreamDF = spark.<span class="fu">read</span>.<span class="fu">json</span>(<span class="st">&quot;/data/click-stream/clickstream.json&quot;</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="co">// output :</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="co">// clickstreamDF: org.apache.spark.sql.DataFrame = [action: string, campaign: string, cost: bigint, domain: string, ip: string, session: string, timestamp: bigint, user: string]</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="co">// schema</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  clickstreamDF.<span class="fu">printSchema</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  <span class="co">/* output</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co">  root</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co">   |-- action: string (nullable = true)</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co">   |-- campaign: string (nullable = true)</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co">   |-- cost: long (nullable = true)</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="co">   |-- domain: string (nullable = true)</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co">   |-- ip: string (nullable = true)</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co">   |-- session: string (nullable = true)</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">   |-- timestamp: long (nullable = true)</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co">   |-- user: string (nullable = true)</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">   */</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">  clickstreamDF.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">  <span class="co">// nicely formated table output</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">  <span class="kw">import</span> spark.<span class="fu">implicits</span>._</a>
<a class="sourceLine" id="cb2-25" data-line-number="25"></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">  <span class="co">// Show only click logs where the cost &gt; 100</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">  clickstreamDF.<span class="fu">filter</span>(<span class="fu">clickstreamDF</span>(<span class="st">&quot;cost&quot;</span>) &gt; <span class="dv">100</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">  clickstreamDF.<span class="fu">filter</span>(<span class="st">&quot;cost &gt; 100&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb2-29" data-line-number="29">  clickstreamDF.<span class="fu">filter</span>($<span class="st">&quot;cost&quot;</span> &gt; <span class="dv">100</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb2-30" data-line-number="30"></a>
<a class="sourceLine" id="cb2-31" data-line-number="31">  <span class="co">// Show the logs where action = clicked</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">  clickstreamDF.<span class="fu">filter</span>(<span class="fu">clickstreamDF</span>(<span class="st">&quot;action&quot;</span>) === <span class="st">&quot;clicked&quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33">  <span class="co">// another way</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34">  clickstreamDF.<span class="fu">filter</span>(<span class="fu">clickstreamDF</span>(<span class="st">&quot;action&quot;</span>).<span class="fu">equalTo</span>(<span class="st">&quot;clicked&quot;</span>)).<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-35" data-line-number="35"></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">  <span class="co">// show traffic per domain</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37">  <span class="co">// step by step</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38">  <span class="kw">val</span> g = clickstreamDF.<span class="fu">groupBy</span>(<span class="st">&quot;domain&quot;</span>)</a>
<a class="sourceLine" id="cb2-39" data-line-number="39">  <span class="kw">val</span> c = g.<span class="fu">count</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40">  c.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41"></a>
<a class="sourceLine" id="cb2-42" data-line-number="42">  <span class="co">// one-liner</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">  clickstreamDF.<span class="fu">groupBy</span>(<span class="st">&quot;domain&quot;</span>).<span class="fu">count</span>.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-44" data-line-number="44"></a>
<a class="sourceLine" id="cb2-45" data-line-number="45"></a>
<a class="sourceLine" id="cb2-46" data-line-number="46">  <span class="co">// load domain info</span></a>
<a class="sourceLine" id="cb2-47" data-line-number="47">  <span class="kw">val</span> domainsDF = spark.<span class="fu">read</span>.<span class="fu">json</span>(<span class="st">&quot;/data/click-stream/domain-info.json&quot;</span>)</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">  domainsDF.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-49" data-line-number="49"></a>
<a class="sourceLine" id="cb2-50" data-line-number="50">  <span class="co">// inner join</span></a>
<a class="sourceLine" id="cb2-51" data-line-number="51">  <span class="kw">val</span> joined = clickstreamDF.<span class="fu">join</span>(domainsDF,  <span class="fu">clickstreamDF</span>(<span class="st">&quot;domain&quot;</span>) === <span class="fu">domainsDF</span>(<span class="st">&quot;domain&quot;</span>))</a>
<a class="sourceLine" id="cb2-52" data-line-number="52">  joined.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-53" data-line-number="53"></a>
<a class="sourceLine" id="cb2-54" data-line-number="54">  <span class="co">// outer join</span></a>
<a class="sourceLine" id="cb2-55" data-line-number="55">  <span class="kw">val</span> joinedOuter = clickstreamDF.<span class="fu">join</span>(domainsDF,  <span class="fu">clickstreamDF</span>(<span class="st">&quot;domain&quot;</span>) === <span class="fu">domainsDF</span>(<span class="st">&quot;domain&quot;</span>), <span class="st">&quot;outer&quot;</span>)</a>
<a class="sourceLine" id="cb2-56" data-line-number="56">  joinedOuter.<span class="fu">show</span></a></code></pre></div>
