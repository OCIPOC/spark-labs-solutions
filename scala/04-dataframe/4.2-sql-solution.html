<h1 id="lab-4.2-dataframe-sql-solution">Lab 4.2 : Dataframe SQL solution</h1>
<h4 id="start-spark-shell">Start Spark Shell</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">  $   <span class="ex">~/spark/bin/spark-shell</span></a></code></pre></div>
<h4 id="following-in-scala-shell">Following in Scala shell</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb2-1" data-line-number="1">  <span class="co">// scala</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="kw">val</span> clickstreamDF = spark.<span class="fu">read</span>.<span class="fu">json</span>(<span class="st">&quot;/data/click-stream/clickstream.json&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  clickstreamDF.<span class="fu">createOrReplaceTempView</span>(<span class="st">&quot;clickstream&quot;</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="kw">val</span> logs = spark.<span class="fu">sql</span>(<span class="st">&quot;select * from clickstream&quot;</span>)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  logs.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="co">// find only clicks</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  spark.<span class="fu">sql</span>(<span class="st">&quot;select * from clickstream where action = &#39;clicked&#39;&quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  <span class="co">// count traffic by domains</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  spark.<span class="fu">sql</span>(<span class="st">&quot;select domain, count(*) as traffic from clickstream group by domain order by traffic desc&quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">  <span class="co">// load domain info</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">  <span class="kw">val</span> domainsDF = spark.<span class="fu">read</span>.<span class="fu">json</span>(<span class="st">&quot;/data/click-stream/domain-info.json&quot;</span>)</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">  domainsDF.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  domainsDF.<span class="fu">createOrReplaceTempView</span>(<span class="st">&quot;domains&quot;</span>)</a>
<a class="sourceLine" id="cb2-18" data-line-number="18"></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">  <span class="co">// inner join</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">  spark.<span class="fu">sql</span>(<span class="st">&quot;select clickstream.*, domains.* from clickstream  join domains  ON (clickstream.domain = domains.domain) &quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">  <span class="co">// outer join</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">  spark.<span class="fu">sql</span>(<span class="st">&quot;select clickstream.*, domains.* from clickstream  left outer join domains  ON (clickstream.domain = domains.domain) &quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">  <span class="co">// traffic by domain category</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">  spark.<span class="fu">sql</span>(<span class="st">&quot;select   domains.category as category, count(*) as total  from clickstream  left outer join domains  ON (clickstream.domain = domains.domain) group by category order by total desc&quot;</span>).<span class="fu">show</span></a></code></pre></div>
