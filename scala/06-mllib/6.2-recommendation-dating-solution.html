<h2 id="recommendation-solution">Recommendation solution</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">mllib</span>.<span class="fu">recommendation</span>.<span class="fu">ALS</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">mllib</span>.<span class="fu">recommendation</span>.<span class="fu">Rating</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">rdd</span>.<span class="fu">RDD</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">def</span> <span class="fu">parseData</span>(vals : RDD[String]) : RDD[Rating] = {</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  vals.<span class="fu">map</span>(_.<span class="fu">split</span>(<span class="ch">&#39;,&#39;</span>) <span class="kw">match</span> { <span class="kw">case</span> Array(user, item, rating) =&gt;</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    <span class="fu">Rating</span>(user.<span class="fu">toInt</span>, item.<span class="fu">toInt</span>, rating.<span class="fu">toDouble</span>)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  })</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co">// For the dating website </span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co">// Users = Users</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="co">// Items = other users</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="kw">val</span> data = sc.<span class="fu">textFile</span>(<span class="st">&quot;../../data/dating/medium/ratings.dat&quot;</span>)</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="kw">val</span> ratings = <span class="fu">parseData</span>(data)</a>
<a class="sourceLine" id="cb1-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="co">// ALS.train (rdd, rank, iterations, lambda)</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="co">//    - rank : how many features to use</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="co">//    - lambda : regularization factor (recommended: 0.01)</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="co">// http://spark.apache.org/docs/latest/api/scala/index.html#org.apache.spark.mllib.recommendation.ALS$</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="kw">val</span> model = ALS.<span class="fu">train</span>(ratings, rank = <span class="dv">10</span>, iterations = <span class="dv">5</span>, <span class="fl">0.01</span>)</a>
<a class="sourceLine" id="cb1-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="kw">val</span> usersItems = ratings.<span class="fu">map</span> { <span class="kw">case</span> <span class="fu">Rating</span>(user, item, rating) =&gt;</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">  (user, item)</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">}</a>
<a class="sourceLine" id="cb1-28" data-line-number="28"></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"><span class="kw">val</span> recs = </a>
<a class="sourceLine" id="cb1-31" data-line-number="31">  model.<span class="fu">predict</span>(usersItems).<span class="fu">map</span> { <span class="kw">case</span> <span class="fu">Rating</span>(user, item, rating) =&gt; </a>
<a class="sourceLine" id="cb1-32" data-line-number="32">    ((user, item), rating)</a>
<a class="sourceLine" id="cb1-33" data-line-number="33">  }</a>
<a class="sourceLine" id="cb1-34" data-line-number="34"></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="kw">val</span> ratingsAndRecs = ratings.<span class="fu">map</span> { <span class="kw">case</span> <span class="fu">Rating</span>(user, item, rating) =&gt; </a>
<a class="sourceLine" id="cb1-36" data-line-number="36">  ((user, item), rating)</a>
<a class="sourceLine" id="cb1-37" data-line-number="37">}.<span class="fu">join</span>(recs)</a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="kw">val</span> MSE = ratingsAndRecs.<span class="fu">map</span> { <span class="kw">case</span> ((user, item), (r1, r2)) =&gt; </a>
<a class="sourceLine" id="cb1-39" data-line-number="39">  <span class="kw">val</span> err = (r1 - r2)</a>
<a class="sourceLine" id="cb1-40" data-line-number="40">  err * err</a>
<a class="sourceLine" id="cb1-41" data-line-number="41">}.<span class="fu">mean</span>()</a>
<a class="sourceLine" id="cb1-42" data-line-number="42"><span class="fu">println</span>(<span class="st">&quot;Mean Squared Error = &quot;</span> + MSE)</a>
<a class="sourceLine" id="cb1-43" data-line-number="43"></a>
<a class="sourceLine" id="cb1-44" data-line-number="44"><span class="kw">val</span> personaldata = sc.<span class="fu">textFile</span>(<span class="st">&quot;personalratings.txt&quot;</span>)</a>
<a class="sourceLine" id="cb1-45" data-line-number="45"></a>
<a class="sourceLine" id="cb1-46" data-line-number="46"><span class="kw">val</span> personalratings = <span class="fu">parseData</span>(personaldata)</a>
<a class="sourceLine" id="cb1-47" data-line-number="47"></a>
<a class="sourceLine" id="cb1-48" data-line-number="48"><span class="kw">val</span> recsForEachUser = recs.<span class="fu">map</span> { <span class="kw">case</span> ((user, item), rating) =&gt; (user, item, rating) </a>
<a class="sourceLine" id="cb1-49" data-line-number="49">  }.<span class="fu">collect</span>.<span class="fu">groupBy</span>(_._<span class="dv">1</span>).<span class="fu">mapValues</span>(_.<span class="fu">sortBy</span>(- _._<span class="dv">3</span>).<span class="fu">take</span>(<span class="dv">4</span>)).<span class="fu">mapValues</span>(_.<span class="fu">map</span>(_._<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb1-50" data-line-number="50"></a>
<a class="sourceLine" id="cb1-51" data-line-number="51">exit <span class="co">// exit shell</span></a></code></pre></div>
