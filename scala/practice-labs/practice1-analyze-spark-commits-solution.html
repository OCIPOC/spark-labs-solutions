<h1 id="practice-lab-analyzing-spark-commit-logs-csv">4.3 Practice Lab : Analyzing Spark commit logs (CSV)</h1>
<p>Please see this blog post for solution and a screen cast. http://elephantscale.com/2017/05/processing-csv-files-spark-2-part-1/</p>
<hr />
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">  $  <span class="ex">~/spark/bin/spark-shell</span></a></code></pre></div>
<p>An in Spark-shell, step by step</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">// default read</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">val</span> commits = spark.<span class="fu">read</span>.<span class="fu">csv</span>(<span class="st">&quot;/data/spark-commits/sample.log&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">commits.<span class="fu">printSchema</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">// with header</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">val</span> commits = spark.<span class="fu">read</span>.</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">              <span class="fu">option</span>(<span class="st">&quot;header&quot;</span>, <span class="st">&quot;true&quot;</span>).</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">              <span class="fu">csv</span>(<span class="st">&quot;/data/spark-commits/sample.log&quot;</span>)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">commits.<span class="fu">printSchema</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co">// header + custom delimiter</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="kw">val</span> commits = spark.<span class="fu">read</span>.</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">              <span class="fu">option</span>(<span class="st">&quot;header&quot;</span>, <span class="st">&quot;true&quot;</span>).</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">              <span class="fu">option</span>(<span class="st">&quot;delimiter&quot;</span>, <span class="st">&quot;|&quot;</span>).</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">              <span class="fu">csv</span>(<span class="st">&quot;/data/spark-commits/sample.log&quot;</span>)</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">commits.<span class="fu">printSchema</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">commits.<span class="fu">show</span>(<span class="kw">false</span>)</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">commits.<span class="fu">count</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="co">// ==== good to go!</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="co">// read the full file</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="kw">val</span> commits = spark.<span class="fu">read</span>.</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">              <span class="fu">option</span>(<span class="st">&quot;header&quot;</span>, <span class="st">&quot;true&quot;</span>).</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">              <span class="fu">option</span>(<span class="st">&quot;delimiter&quot;</span>, <span class="st">&quot;|&quot;</span>).</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">              <span class="fu">csv</span>(<span class="st">&quot;/data/spark-commits/spark-commits.log&quot;</span>)</a>
<a class="sourceLine" id="cb2-27" data-line-number="27">commits.<span class="fu">count</span> <span class="co">// 19001</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28"></a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="co">// find commits from databricks</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="kw">val</span> db = commits.<span class="fu">filter</span>(<span class="fu">commits</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">contains</span>(<span class="st">&quot;databricks.com&quot;</span>))</a>
<a class="sourceLine" id="cb2-31" data-line-number="31">db.<span class="fu">count</span> <span class="co">// 4116</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">db.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33"></a>
<a class="sourceLine" id="cb2-34" data-line-number="34"><span class="co">// find top committers</span></a>
<a class="sourceLine" id="cb2-35" data-line-number="35">commits.<span class="fu">groupBy</span>(<span class="st">&quot;email&quot;</span>)</a>
<a class="sourceLine" id="cb2-36" data-line-number="36">commits.<span class="fu">groupBy</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">count</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37">commits.<span class="fu">groupBy</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">count</span>.<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38">commits.<span class="fu">groupBy</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">count</span>.<span class="fu">printSchema</span></a>
<a class="sourceLine" id="cb2-39" data-line-number="39"><span class="co">// sort by desc</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40">commits.<span class="fu">groupBy</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">count</span>.<span class="fu">orderBy</span>(<span class="fu">desc</span>(<span class="st">&quot;count&quot;</span>))</a>
<a class="sourceLine" id="cb2-41" data-line-number="41">commits.<span class="fu">groupBy</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">count</span>.<span class="fu">orderBy</span>(<span class="fu">desc</span>(<span class="st">&quot;count&quot;</span>)).<span class="fu">show</span></a>
<a class="sourceLine" id="cb2-42" data-line-number="42"><span class="co">// show top-10</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">commits.<span class="fu">groupBy</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">count</span>.<span class="fu">orderBy</span>(<span class="fu">desc</span>(<span class="st">&quot;count&quot;</span>)).<span class="fu">show</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb2-44" data-line-number="44"></a>
<a class="sourceLine" id="cb2-45" data-line-number="45"><span class="co">// +--------------------+-----+</span></a>
<a class="sourceLine" id="cb2-46" data-line-number="46"><span class="co">// | email              |count|</span></a>
<a class="sourceLine" id="cb2-47" data-line-number="47"><span class="co">// +--------------------+-----+</span></a>
<a class="sourceLine" id="cb2-48" data-line-number="48"><span class="co">// |matei@eecs.berkel...| 1341|</span></a>
<a class="sourceLine" id="cb2-49" data-line-number="49"><span class="co">// | pwendell@gmail.com |  791|</span></a>
<a class="sourceLine" id="cb2-50" data-line-number="50"><span class="co">// | rxin@databricks.com|  700|</span></a>
<a class="sourceLine" id="cb2-51" data-line-number="51"><span class="co">// |tathagata.das1565...|  502|</span></a>
<a class="sourceLine" id="cb2-52" data-line-number="52"><span class="co">// | rxin@apache.org    |  430|</span></a>
<a class="sourceLine" id="cb2-53" data-line-number="53"><span class="co">// -----</span></a>
<a class="sourceLine" id="cb2-54" data-line-number="54"></a></code></pre></div>
<h3 id="solution-one-liner">Solution one liner</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">val</span> commits = spark.<span class="fu">read</span>.</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">              <span class="fu">option</span>(<span class="st">&quot;header&quot;</span>, <span class="st">&quot;true&quot;</span>).</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">              <span class="fu">option</span>(<span class="st">&quot;delimiter&quot;</span>, <span class="st">&quot;|&quot;</span>).</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">              <span class="fu">csv</span>(<span class="st">&quot;/data/spark-commits/spark-commits.csv&quot;</span>)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">commits.<span class="fu">groupBy</span>(<span class="st">&quot;email&quot;</span>).<span class="fu">count</span>.<span class="fu">orderBy</span>(<span class="fu">desc</span>(<span class="st">&quot;count&quot;</span>)).<span class="fu">show</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">// alternative</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">commitDS.<span class="fu">groupBy</span>($<span class="st">&quot;committer&quot;</span>).<span class="fu">count</span>.<span class="fu">orderBy</span>($<span class="st">&quot;count&quot;</span>.<span class="fu">desc</span>).<span class="fu">withColumnRenamed</span>(<span class="st">&quot;count&quot;</span>,<span class="st">&quot;Count&quot;</span>).<span class="fu">show</span>(<span class="dv">1</span>)</a></code></pre></div>
<h3 id="solution-using-sql">Solution using sql</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb4-1" data-line-number="1"></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">val</span> commits = spark.<span class="fu">read</span>.</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">              <span class="fu">option</span>(<span class="st">&quot;header&quot;</span>, <span class="st">&quot;true&quot;</span>).</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">              <span class="fu">option</span>(<span class="st">&quot;delimiter&quot;</span>, <span class="st">&quot;|&quot;</span>).</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">              <span class="fu">csv</span>(<span class="st">&quot;/data/spark-commits/spark-commits.csv&quot;</span>)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"> commits.<span class="fu">createOrReplaceTempView</span>(<span class="st">&quot;commits&quot;</span>)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"> spark.<span class="fu">catalog</span>.<span class="fu">listTables</span>.<span class="fu">show</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"> spark.<span class="fu">sql</span>(<span class="st">&quot;select * from commits&quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"> -- find commits from databricks.<span class="fu">com</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"> spark.<span class="fu">sql</span>(<span class="st">&quot;select * from commits where email like &#39;%databricks.com&#39;&quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"> spark.<span class="fu">sql</span>(<span class="st">&quot;select count(*) from commits where email like &#39;%databricks.com&#39;&quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"> -- find max commits</a>
<a class="sourceLine" id="cb4-19" data-line-number="19"> spark.<span class="fu">sql</span>(<span class="st">&quot;select email, count(*) as total  from commits group by email order by total desc limit 10&quot;</span>).<span class="fu">show</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">// output</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">// +--------------------+-----+</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">// |               email|total|</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="co">// +--------------------+-----+</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co">// |matei@eecs.berkel...| 1341|</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="co">// |  pwendell@gmail.com|  791|</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="co">// | rxin@databricks.com|  700|</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28"><span class="co">// |tathagata.das1565...|  502|</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="co">// |     rxin@apache.org|  430|</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="co">// |davies@databricks...|  389|</span></a>
<a class="sourceLine" id="cb4-31" data-line-number="31"><span class="co">// | meng@databricks.com|  338|</span></a>
<a class="sourceLine" id="cb4-32" data-line-number="32"><span class="co">// |  sowen@cloudera.com|  332|</span></a>
<a class="sourceLine" id="cb4-33" data-line-number="33"><span class="co">// |joshrosen@databri...|  311|</span></a>
<a class="sourceLine" id="cb4-34" data-line-number="34"><span class="co">// |wenchen@databrick...|  282|</span></a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="co">// +--------------------+-----+</span></a></code></pre></div>
